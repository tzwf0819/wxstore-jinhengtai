name: Nginx Setup

on:
  workflow_dispatch:

jobs:
  setup-nginx:
    runs-on: ubuntu-latest

    steps:
    - name: Setup Nginx on Cloud Host
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 600s
        script: |
          set -euo pipefail

          echo "Updating system packages..."
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            INSTALL_CMD="sudo apt-get install -y"
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf makecache
            INSTALL_CMD="sudo dnf install -y"
          elif command -v yum >/dev/null 2>&1; then
            sudo yum makecache
            INSTALL_CMD="sudo yum install -y"
          else
            echo "Unsupported package manager. Install Nginx manually." >&2
            exit 1
          fi

          if ! command -v nginx >/dev/null 2>&1; then
            echo "Installing Nginx..."
            ${INSTALL_CMD} nginx
          fi

          echo "Creating Nginx configuration directory..."
          sudo mkdir -p /etc/nginx/sites-available/

          echo "Writing Nginx configuration..."
          sudo tee /etc/nginx/sites-available/cloudbase > /dev/null <<'EOF'
          server {
              listen 80;
              server_name ${{ secrets.JINHENGTAI_HOST }};

              access_log /var/log/nginx/cloudbase_access.log;
              error_log /var/log/nginx/cloudbase_error.log;

              location /api/ {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  proxy_read_timeout 300s;
                  proxy_connect_timeout 75s;
              }

              location /health {
                  proxy_pass http://127.0.0.1:3000/health;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /admin/ {
                  alias /opt/cloudbase/admin/dist/;
                  try_files $uri $uri/ /admin/index.html;

                  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }

              location /uploads/ {
                  alias /opt/cloudbase/uploads/;
                  expires 1y;
                  add_header Cache-Control "public";
              }

              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

              server_tokens off;
          }
          EOF

          echo "Enabling site..."
          sudo ln -sf /etc/nginx/sites-available/cloudbase /etc/nginx/sites-enabled/cloudbase
          sudo rm -f /etc/nginx/sites-enabled/default

          echo "Testing Nginx configuration..."
          sudo nginx -t

          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl enable nginx

          echo "Configuring firewall..."
          if command -v ufw >/dev/null 2>&1; then
            sudo ufw allow 'Nginx Full'
          else
            echo "UFW not available or already configured"
          fi

          echo "Nginx setup completed!"
          echo "API: http://${{ secrets.JINHENGTAI_HOST }}/api/"
          echo "Health: http://${{ secrets.JINHENGTAI_HOST }}/health"
          echo "Admin: http://${{ secrets.JINHENGTAI_HOST }}/admin/"
