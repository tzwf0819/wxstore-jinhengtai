
name: Deploy Project

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      setup_database:
        description: 'Run database schema setup'
        required: false
        type: boolean

jobs:
  deploy-and-configure:
    name: Deploy Backend and Configure Nginx
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: pip
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file for testing
      working-directory: backend
      run: |
        echo "SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}" >> .env
        echo "SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}" >> .env
        echo "SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}" >> .env
        echo "SQL_SERVER_PASSWORD='${{ secrets.JINHENGTAI_DB_PASSWORD }}'" >> .env
        echo "SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}" >> .env

    - name: Run tests
      working-directory: backend
      run: pytest

    - name: Create deployment package
      working-directory: backend
      run: tar -czf ../backend-deploy.tar.gz .

    - name: Deploy package to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        source: "backend-deploy.tar.gz"
        target: "/tmp/"

    - name: Setup Backend and Nginx on Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 180s
        script: |
          set -euo pipefail
          
          # --- Backend Deployment ---
          PROJECT_DIR="/opt/cloudbase"
          BACKEND_DIR="${PROJECT_DIR}/backend"
          VENV_DIR="${PROJECT_DIR}/venv"
          SERVICE_NAME="jinhengtai-backend"
          TIMESTAMP="$(date +%Y%m%d_%H%M%S)"

          echo "--- Starting backend deployment at ${TIMESTAMP} ---"
          sudo mkdir -p "${PROJECT_DIR}" "${PROJECT_DIR}/backup"
          if [ -d "${BACKEND_DIR}" ]; then
              echo "Backing up existing backend..."
              sudo mv "${BACKEND_DIR}" "/opt/cloudbase/backup/backend_${TIMESTAMP}"
          fi
          echo "Extracting new backend code..."
          sudo mkdir -p "${BACKEND_DIR}"
          sudo tar -xzf "/tmp/backend-deploy.tar.gz" -C "${BACKEND_DIR}"
          sudo rm "/tmp/backend-deploy.tar.gz"

          # The server's default python3 is 3.6, which is too old for fastapi==0.115.0.
          # We will use python3.8, assuming it's available on the server.
          # We also remove the old venv directory to ensure a clean environment.
          echo "Recreating Python virtual environment with a modern Python version..."
          sudo rm -rf "${VENV_DIR}"
          sudo python3.8 -m venv "${VENV_DIR}"

          echo "Installing Python dependencies..."
          sudo "${VENV_DIR}/bin/pip" install --upgrade pip
          sudo "${VENV_DIR}/bin/pip" install -r "${BACKEND_DIR}/requirements.txt"

          echo "Creating .env file..."
          sudo tee "${BACKEND_DIR}/.env" > /dev/null <<EOF
          SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}
          SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}
          SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}
          SQL_SERVER_PASSWORD='${{ secrets.JINHENGTAI_DB_PASSWORD }}'
          SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}
          EOF

          echo "Restarting the backend service..."
          sudo systemctl daemon-reload
          sudo systemctl restart "${SERVICE_NAME}"
          sudo systemctl status "${SERVICE_NAME}" --no-pager
          echo "--- Backend deployment finished successfully! ---"

          # --- Nginx Setup ---
          echo "--- Starting Nginx setup on ${{ secrets.JINHENGTAI_HOST }} ---"
          if ! command -v nginx &> /dev/null; then
              echo "Nginx not found, installing..."
              sudo apt-get update
              sudo apt-get install -y nginx
          fi
          
          echo "Writing Nginx configuration..."
          sudo tee /etc/nginx/sites-available/backend_proxy > /dev/null <<'EOF'
          server {
              listen 80;
              # This will be the default server for port 80
              server_name _;

              location / {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF

          echo "Enabling Nginx site..."
          sudo ln -sf /etc/nginx/sites-available/backend_proxy /etc/nginx/sites-enabled/backend_proxy
          if [ -f /etc/nginx/sites-enabled/default ]; then
              sudo rm /etc/nginx/sites-enabled/default
          fi

          echo "Testing and restarting Nginx..."
          sudo nginx -t
          sudo systemctl restart nginx
          echo "--- Nginx setup finished successfully! ---"

  setup-database:
    name: Setup Database Schema
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_database == 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSSQL Tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
        echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH
        
    - name: Deploy and execute database schema
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        script: |
            echo "Initializing database schema..."
            sqlcmd -S ${{ secrets.JINHENGTAI_DB_HOST }},${{ secrets.JINHENGTAI_DB_PORT }} \
                   -U ${{ secrets.JINHENGTAI_DB_USER }} \
                   -P '${{ secrets.JINHENGTAI_DB_PASSWORD }}' \
                   -d ${{ secrets.JINHENGTAI_DB_NAME }} \
                   -i /opt/cloudbase/backend/database/schema.sql \
                   -C || echo "Database schema execution completed with warnings"
            
            echo "Database initialization completed!"
