name: Deploy Jinhengtai Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.JINHENGTAI_HOST }}
          username: ${{ secrets.JINHENGTAI_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }} # 使用我们之前创建的部署私钥
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            # 1. 定义部署目录
            PROJECT_DIR="/var/www/jinhengtai"
            echo "--- Deploying to directory: $PROJECT_DIR ---"
            sudo mkdir -p "$PROJECT_DIR"

            # 2. 备份关键文件
            TEMP_BACKUP="$(mktemp -d)"
            echo "Creating temporary backup at: $TEMP_BACKUP"
            if [ -f "$PROJECT_DIR/backend/.env" ]; then
              sudo cp "$PROJECT_DIR/backend/.env" "$TEMP_BACKUP/backend.env"
              echo "Backed up .env file."
            fi

            # 3. 清理旧文件
            echo "Cleaning up old files..."
            cd "$PROJECT_DIR"
            sudo find . -mindepth 1 ! -name '.env.bak' -exec rm -rf {} + || true

            # 4. 下载最新的代码 (简单 Wget 方法)
            echo "Downloading latest source code via wget..."
            wget -O latest.zip "https://github.com/${{ github.repository }}/archive/refs/heads/main.zip"
            
            # 解压并移动文件
            TEMP_UNZIP_DIR="$(mktemp -d)"
            unzip -q -o latest.zip -d "$TEMP_UNZIP_DIR"
            # 找到解压出的目录名 (通常是 reponame-main)
            EXTRACTED_DIR=$(ls "$TEMP_UNZIP_DIR")
            sudo mv "$TEMP_UNZIP_DIR/$EXTRACTED_DIR"/* .
            sudo mv "$TEMP_UNZIP_DIR/$EXTRACTED_DIR"/.* . 2>/dev/null || true
            
            # 清理下载和解压的临时文件
            sudo rm -rf "$TEMP_UNZIP_DIR" latest.zip
            echo "Code downloaded and extracted."

            # 5. 恢复备份
            if [ -f "$TEMP_BACKUP/backend.env" ]; then
              sudo mv "$TEMP_BACKUP/backend.env" "$PROJECT_DIR/backend/.env"
              echo "Restored .env file."
            fi
            sudo rm -rf "$TEMP_BACKUP"

            # 6. 运行项目自己的部署脚本
            echo "Running the project deployment script..."
            if [ -f "./deploy_jinhengtai.sh" ]; then
              sudo chmod +x ./deploy_jinhengtai.sh
              sudo ./deploy_jinhengtai.sh
            else
              echo "Warning: deploy_jinhengtai.sh not found!"
            fi

            echo "Deployment script finished."
