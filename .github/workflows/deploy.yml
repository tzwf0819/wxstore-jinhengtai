name: Deploy Jinhengtai Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.JINHENGTAI_HOST }}
          username: ${{ secrets.JINHENGTAI_USERNAME }}
          password: ${{ secrets.JINHENGTAI_PASSWORD }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            # 1. 定义此项目的独立部署目录
            PROJECT_DIR="/var/www/jinhengtai"
            echo "--- Deploying to isolated directory: $PROJECT_DIR ---"
            sudo mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # 2. 备份关键的 .env 文件 (如果存在)
            if [ -f "backend/.env" ]; then
              echo "Backing up existing .env file..."
              sudo cp backend/.env .env.bak
            fi

            # 3. 清理旧文件，但保留备份
            echo "Cleaning up old files..."
            sudo find . -mindepth 1 ! -name '.env.bak' -exec rm -rf {} +

            # 4. 下载最新的代码 (Public Repo)
            echo "--- Cloning public repository ---"

            # 确保服务器上安装了 git
            echo "Ensuring git is installed..."
            if command -v yum &> /dev/null; then
                sudo yum install -y git || echo "Yum command failed. Assuming git is present."
            elif command -v apt-get &> /dev/null; then
                sudo apt-get update -y > /dev/null && sudo apt-get install -y git || echo "Apt command failed. Assuming git is present."
            else
                echo "Warning: No package manager found. Assuming git is present."
            fi

            # 直接通过 HTTPS 克隆公开仓库
            echo "Cloning repository via HTTPS..."
            TEMP_CLONE_DIR=$(mktemp -d)
            git clone --depth 1 https://github.com/${{ github.repository }}.git "$TEMP_CLONE_DIR"

            # 将克隆下来的所有文件移动到项目目录
            echo "Moving files into project directory..."
            sudo mv "$TEMP_CLONE_DIR"/* .
            sudo mv "$TEMP_CLONE_DIR"/.* . 2>/dev/null || true
            sudo rm -rf "$TEMP_CLONE_DIR"

            # 5. 恢复 .env 文件
            if [ -f ".env.bak" ]; then
              echo "Restoring .env file..."
              sudo mv .env.bak backend/.env
            fi

            # 6. 授予部署脚本执行权限并运行
            echo "Running the deployment script on the server..."
            sudo chmod +x ./deploy_jinhengtai.sh
            sudo ./deploy_jinhengtai.sh
