name: Deploy Jinhengtai Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.JINHENGTAI_HOST }}
          username: ${{ secrets.JINHENGTAI_USERNAME }}
          password: ${{ secrets.JINHENGTAI_PASSWORD }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            # 1. 定义此项目的独立部署目录
            PROJECT_DIR="/var/www/jinhengtai"
            echo "--- Deploying to isolated directory: $PROJECT_DIR ---"
            sudo mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # 2. 备份关键的 .env 文件 (如果存在)
            if [ -f "backend/.env" ]; then
              echo "Backing up existing .env file..."
              sudo cp backend/.env .env.bak
            fi

            # 3. 清理旧文件，但保留备份
            echo "Cleaning up old files..."
            # 删除所有文件和隐藏文件，除了 .env.bak
            sudo find . -mindepth 1 ! -name '.env.bak' -exec rm -rf {} +

            # 4. 下载最新的代码
            echo "Downloading latest source code from main branch..."
            wget -qO latest.zip "https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}/archive/refs/heads/main.zip"
            unzip -q -o latest.zip
            # 从解压出的带版本号的目录中，将所有文件（包括隐藏文件）移动到当前目录
            EXTRACTED_DIR=$(unzip -Z1 latest.zip | head -1 | sed 's@/.*@@')
            sudo mv "$EXTRACTED_DIR"/* .
            sudo mv "$EXTRACTED_DIR"/.* . 2>/dev/null || true
            rm latest.zip
            rm -rf "$EXTRACTED_DIR"

            # 5. 恢复 .env 文件
            if [ -f ".env.bak" ]; then
              echo "Restoring .env file..."
              sudo mv .env.bak backend/.env
            fi

            # 6. 授予部署脚本执行权限并运行
            echo "Running the deployment script on the server..."
            sudo chmod +x ./deploy_jinhengtai.sh
            sudo ./deploy_jinhengtai.sh

