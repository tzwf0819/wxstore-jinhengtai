name: Deploy Jinhengtai Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.JINHENGTAI_HOST }}
          username: ${{ secrets.JINHENGTAI_USERNAME }}
          password: ${{ secrets.JINHENGTAI_PASSWORD }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            # 1. 定义此项目的独立部署目录
            PROJECT_DIR="/var/www/jinhengtai"
            echo "--- Deploying to isolated directory: $PROJECT_DIR ---"
            sudo mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # 2. 备份关键的 .env 文件 (如果存在)
            if [ -f "backend/.env" ]; then
              echo "Backing up existing .env file..."
              sudo cp backend/.env .env.bak
            fi

            # 3. 清理旧文件，但保留备份
            echo "Cleaning up old files..."
            # 删除所有文件和隐藏文件，除了 .env.bak
            sudo find . -mindepth 1 ! -name '.env.bak' -exec rm -rf {} +

            # 4. 下载最新的代码 (Git Clone 方法)
            echo "Cloning latest source code from main branch..."
            # 确保服务器上安装了 git
            echo "Ensuring git is installed..."
            # 自动检测包管理器 (apt-get for Debian/Ubuntu, yum for CentOS) 并安装 git
            if command -v apt-get &> /dev/null; then
                sudo apt-get update -y > /dev/null
                sudo apt-get install -y git
            elif command -v yum &> /dev/null; then
                # 尝试安装 git，但如果失败则忽略错误，因为 git 很可能已安装
    sudo yum install -y git || echo "yum install failed, proceeding with assumption that git is already installed."
            else
                echo "Warning: Could not find apt-get or yum. Assuming git is already installed."
            fi

            # 创建一个临时目录进行克隆
            TEMP_CLONE_DIR=$(mktemp -d)
            echo "Cloning into temporary directory: $TEMP_CLONE_DIR"
            # 使用 token 克隆代码到临时目录
            sudo git clone --depth 1 https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git "$TEMP_CLONE_DIR"

            # 将克隆下来的所有文件（包括隐藏文件）移动到当前项目目录
            echo "Moving files into project directory..."
            sudo mv "$TEMP_CLONE_DIR"/* .
            sudo mv "$TEMP_CLONE_DIR"/.* . 2>/dev/null || true

            # 清理临时目录
            echo "Cleaning up..."
            sudo rm -rf "$TEMP_CLONE_DIR"

            # 5. 恢复 .env 文件
            if [ -f ".env.bak" ]; then
              echo "Restoring .env file..."
              sudo mv .env.bak backend/.env
            fi

            # 6. 授予部署脚本执行权限并运行
            echo "Running the deployment script on the server..."
            sudo chmod +x ./deploy_jinhengtai.sh
            sudo ./deploy_jinhengtai.sh

