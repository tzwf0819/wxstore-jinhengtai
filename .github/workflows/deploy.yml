name: Deploy to Cloud Host

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential unixodbc-dev

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run backend tests
      working-directory: ./backend
      run: |
        pytest

    - name: Setup MSSQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18
        echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc

    - name: Deploy to Cloud Host
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          PROJECT_DIR="/opt/jinhengtai-backend"
          BACKUP_DIR="${PROJECT_DIR}/backup/$(date +%Y%m%d_%H%M%S)"

          sudo mkdir -p "${PROJECT_DIR}" "${PROJECT_DIR}/deploy/nginx/conf.d" "${PROJECT_DIR}/deploy/logs"
          sudo mkdir -p "${PROJECT_DIR}/backend" "${PROJECT_DIR}/database"

          if [ -d "${PROJECT_DIR}" ]; then
            echo "Creating backup..."
            sudo mkdir -p "${BACKUP_DIR}"
            sudo cp -r "${PROJECT_DIR}"/* "${BACKUP_DIR}"/ 2>/dev/null || true
          fi

          echo "Stopping FastAPI systemd unit if exists..."
          sudo systemctl stop jinhengtai-backend.service 2>/dev/null || true

          echo "Syncing docker compose stack..."
          sudo mkdir -p "${PROJECT_DIR}/deploy/nginx/conf.d"
          sudo cp /home/${{ secrets.JINHENGTAI_USERNAME }}/cloudbase/backend/deploy/nginx/conf.d/api.conf "${PROJECT_DIR}/deploy/nginx/conf.d/api.conf" 2>/dev/null || true
          sudo cp /home/${{ secrets.JINHENGTAI_USERNAME }}/cloudbase/backend/docker-compose.yml "${PROJECT_DIR}/docker-compose.yml" 2>/dev/null || true

          SQL_PASSWORD="${{ secrets.JINHENGTAI_DB_PASSWORD }}"
          cat <<EOF | sudo tee "${PROJECT_DIR}/.env" > /dev/null
            SQL_SERVER_PASSWORD=${SQL_PASSWORD:-YourStrong@Passw0rd}
            EOF

          if command -v docker >/dev/null 2>&1; then
            cd "${PROJECT_DIR}"
            if command -v docker compose >/dev/null 2>&1; then
              docker compose up -d --build nginx
            elif command -v docker-compose >/dev/null 2>&1; then
              docker-compose up -d --build nginx
            else
              echo "docker compose command not available" >&2
            fi
          else
            echo "Docker is required on the target host" >&2
            exit 1
          fi

          echo "Deployment completed successfully!"
