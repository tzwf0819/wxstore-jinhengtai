name: Deploy Jinhengtai Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.JINHENGTAI_HOST }}
          username: ${{ secrets.JINHENGTAI_USERNAME }}
          password: ${{ secrets.JINHENGTAI_PASSWORD }}
          script_stop: true
          command_timeout: 15m
          script: |
            set -euo pipefail

            # 1. 定义此项目的独立部署目录
            PROJECT_DIR="/var/www/jinhengtai"
            echo "--- Deploying to isolated directory: $PROJECT_DIR ---"
            sudo mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # 2. 备份关键的 .env 文件 (如果存在)
            if [ -f "backend/.env" ]; then
              echo "Backing up existing .env file..."
              sudo cp backend/.env .env.bak
            fi

            # 3. 清理旧文件，但保留备份
            echo "Cleaning up old files..."
            # 删除所有文件和隐藏文件，除了 .env.bak
            sudo find . -mindepth 1 ! -name '.env.bak' -exec rm -rf {} +

            # 4. 下载最新的代码 (SSH Git Clone 方法)
            echo "--- Cloning source code via SSH ---"

            # 确保服务器上安装了 git 和 openssh-clients
            echo "Ensuring git and ssh client are installed..."
            if command -v yum &> /dev/null; then
                sudo yum install -y git openssh-clients || echo "Yum command failed. Assuming tools are present."
            elif command -v apt-get &> /dev/null; then
                sudo apt-get update -y > /dev/null
                sudo apt-get install -y git openssh-clients || echo "Apt command failed. Assuming tools are present."
            else
                echo "Warning: Could not find a package manager. Assuming tools are present."
            fi

            # 设置 SSH 环境，使用我们配置的部署私钥
            echo "Setting up SSH environment for git..."
            # 创建一个临时的 SSH 密钥文件
            SSH_KEY_PATH=$(mktemp)
            # 将密钥从 GitHub Secret 写入该文件
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > "$SSH_KEY_PATH"
            chmod 600 "$SSH_KEY_PATH"

            # 使用 ssh-agent 和 ssh-add 来安全地管理密钥
            # eval `ssh-agent -s`
            # ssh-add "$SSH_KEY_PATH"

            # 创建一个 موقت SSH 包装脚本
            SSH_WRAPPER_PATH=$(mktemp)
            cat > "$SSH_WRAPPER_PATH" <<EOF
#!/bin/sh
ssh -i "$SSH_KEY_PATH" -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no "\$@"
EOF
            chmod +x "$SSH_WRAPPER_PATH"

            # 克隆代码，通过 GIT_SSH_COMMAND 使用我们的包装脚本
            echo "Cloning repository using SSH..."
            TEMP_CLONE_DIR=$(mktemp -d)
            sudo env GIT_SSH_COMMAND="$SSH_WRAPPER_PATH" git clone --depth 1 git@github.com:${{ github.repository }}.git "$TEMP_CLONE_DIR"

            # 清理 SSH 相关文件
            echo "Cleaning up SSH credentials..."
            rm -f "$SSH_KEY_PATH" "$SSH_WRAPPER_PATH"
            # ssh-agent -k

            # 将克隆下来的所有文件移动到项目目录
            echo "Moving files into project directory..."
            sudo mv "$TEMP_CLONE_DIR"/* .
            sudo mv "$TEMP_CLONE_DIR"/.* . 2>/dev/null || true
            sudo rm -rf "$TEMP_CLONE_DIR"


            # 将克隆下来的所有文件（包括隐藏文件）移动到当前项目目录
            echo "Moving files into project directory..."
            sudo mv "$TEMP_CLONE_DIR"/* .
            sudo mv "$TEMP_CLONE_DIR"/.* . 2>/dev/null || true

            # 清理临时目录
            echo "Cleaning up..."
            sudo rm -rf "$TEMP_CLONE_DIR"

            # 5. 恢复 .env 文件
            if [ -f ".env.bak" ]; then
              echo "Restoring .env file..."
              sudo mv .env.bak backend/.env
            fi

            # 6. 授予部署脚本执行权限并运行
            echo "Running the deployment script on the server..."
            sudo chmod +x ./deploy_jinhengtai.sh
            sudo ./deploy_jinhengtai.sh

