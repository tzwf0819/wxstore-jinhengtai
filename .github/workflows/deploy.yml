name: Deploy to Cloud Host

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential unixodbc-dev

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run backend tests
      working-directory: ./backend
      run: |
        pytest

    - name: Setup MSSQL Client
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18
        echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc

    - name: Deploy to Cloud Host
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          PROJECT_DIR="/opt/cloudbase"
          BACKUP_DIR="/opt/cloudbase/backup/$(date +%Y%m%d_%H%M%S)"

          if [ -d "$PROJECT_DIR" ]; then
            echo "Creating backup..."
            sudo mkdir -p $BACKUP_DIR
            sudo cp -r $PROJECT_DIR/* $BACKUP_DIR/ 2>/dev/null || true
          fi

          sudo mkdir -p $PROJECT_DIR
          sudo mkdir -p $PROJECT_DIR/backend
          sudo mkdir -p $PROJECT_DIR/database
          sudo mkdir -p $PROJECT_DIR/logs
          sudo mkdir -p $PROJECT_DIR/uploads

          echo "Stopping existing services..."
          sudo systemctl stop jinhengtai-backend.service 2>/dev/null || true
          sudo pm2 delete cloudbase-admin 2>/dev/null || true

          echo "Installing Python runtime..."
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv python3-pip

          echo "Deployment completed successfully!"
