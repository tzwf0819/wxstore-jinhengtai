name: Backend API Deployment

on:
  push:
    branches: [ main ]
    paths:
      - backend/**
      - database/**
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: pip
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      working-directory: backend
      run: pytest

    - name: Create deployment package
      working-directory: backend
      run: |
        tar -czf ../backend-deploy.tar.gz \
          --exclude=__pycache__ \
          --exclude=.venv \
          --exclude=.env \
          --exclude=tests \
          --exclude='*.pyc' \
          .

    - name: Deploy backend to cloud host
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        source: backend-deploy.tar.gz
        target: /tmp/
        strip_components: 0

    - name: Setup backend on server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 600s
        script: |
          set -e

          PROJECT_DIR="/opt/cloudbase"
          BACKEND_DIR="$PROJECT_DIR/backend"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          echo "Starting backend deployment at $TIMESTAMP"

          sudo mkdir -p "$PROJECT_DIR" "$BACKEND_DIR" "$PROJECT_DIR/logs" "$PROJECT_DIR/uploads"

          if [ -d "$BACKEND_DIR" ]; then
            echo "Backing up existing backend..."
            sudo mkdir -p /opt/cloudbase/backup
            sudo cp -r "$BACKEND_DIR" "/opt/cloudbase/backup/backend_$TIMESTAMP"
          fi

          echo "Extracting new backend..."
          cd /tmp
          sudo tar -xzf backend-deploy.tar.gz -C "$BACKEND_DIR" --strip-components=1

          echo "Installing Python runtime..."
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv python3-pip

          echo "Creating Python environment..."
          cd "$BACKEND_DIR"
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "Writing environment variables..."
          cat <<'EOF' | sudo tee "$BACKEND_DIR/.env" > /dev/null
APP_NAME=Jinhengtai Mall Backend
DEBUG=false
SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}
SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}
SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}
SQL_SERVER_PASSWORD=${{ secrets.JINHENGTAI_DB_PASSWORD }}
SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}
SQL_SERVER_DRIVER=ODBC Driver 18 for SQL Server
EOF

          echo "Setting permissions..."
          sudo chown -R ${{ secrets.JINHENGTAI_USERNAME }}:${{ secrets.JINHENGTAI_USERNAME }} "$BACKEND_DIR"

          echo "Creating systemd service..."
          sudo tee /etc/systemd/system/jinhengtai-backend.service > /dev/null <<'SERVICE'
[Unit]
Description=Jinhengtai FastAPI Backend
After=network.target

[Service]
Type=simple
User=${{ secrets.JINHENGTAI_USERNAME }}
WorkingDirectory=$PROJECT_DIR/backend
EnvironmentFile=$PROJECT_DIR/backend/.env
ExecStart=$PROJECT_DIR/backend/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
SERVICE

          echo "Reloading systemd and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable jinhengtai-backend.service --now
          sudo systemctl restart jinhengtai-backend.service

          echo "Cleaning up deployment package..."
          sudo rm -f /tmp/backend-deploy.tar.gz

          echo "Checking service status..."
          sudo systemctl status --no-pager jinhengtai-backend.service || true
          sudo journalctl -u jinhengtai-backend.service -n 50 --no-pager || true

          echo "Backend deployment completed successfully!"
