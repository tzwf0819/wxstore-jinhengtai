name: Backend API Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: pip
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies (for testing)
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      working-directory: backend
      env:
        SQL_SERVER_HOST: ${{ secrets.JINHENGTAI_DB_HOST }}
        SQL_SERVER_PORT: ${{ secrets.JINHENGTAI_DB_PORT }}
        SQL_SERVER_USER: ${{ secrets.JINHENGTAI_DB_USER }}
        SQL_SERVER_PASSWORD: ${{ secrets.JINHENGTAI_DB_PASSWORD }}
        SQL_SERVER_DATABASE: ${{ secrets.JINHENGTAI_DB_NAME }}
      run: pytest

    - name: Create deployment package
      working-directory: backend
      run: |
        tar -czf ../backend-deploy.tar.gz .

    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 120s
        script: |
          # Upload the package first
          cat <<'EOF' > /tmp/backend-deploy.tar.gz
          ${{ toJSON(open('backend-deploy.tar.gz')) }}
          EOF

          set -euo pipefail
          
          # --- Configuration ---
          PROJECT_DIR="/opt/cloudbase"
          BACKEND_DIR="${PROJECT_DIR}/backend"
          VENV_DIR="${PROJECT_DIR}/venv"
          SERVICE_NAME="jinhengtai-backend" # IMPORTANT: Assumed systemd service name
          TIMESTAMP="$(date +%Y%m%d_%H%M%S)"

          echo "--- Starting backend deployment at ${TIMESTAMP} ---"

          # --- Create required directories ---
          sudo mkdir -p "${PROJECT_DIR}" "${PROJECT_DIR}/backup"

          # --- Backup existing backend (if it exists) ---
          if [ -d "${BACKEND_DIR}" ]; then
              echo "Backing up existing backend to /opt/cloudbase/backup/backend_${TIMESTAMP}"
              sudo mv "${BACKEND_DIR}" "/opt/cloudbase/backup/backend_${TIMESTAMP}"
          fi
          
          # --- Extract new backend code ---
          echo "Extracting new backend code to ${BACKEND_DIR}"
          sudo mkdir -p "${BACKEND_DIR}"
          sudo tar -xzf "/tmp/backend-deploy.tar.gz" -C "${BACKEND_DIR}"
          sudo rm "/tmp/backend-deploy.tar.gz"

          # --- Setup Python Virtual Environment ---
          # Note: Assumes Python 3.8+ (as python3) and python3-venv are pre-installed on the server.
          if [ ! -d "${VENV_DIR}" ]; then
              echo "Creating Python virtual environment at ${VENV_DIR}"
              sudo python3 -m venv "${VENV_DIR}"
          fi

          # --- Install/Update Python dependencies ---
          echo "Installing Python dependencies from requirements.txt"
          sudo "${VENV_DIR}/bin/pip" install --upgrade pip
          sudo "${VENV_DIR}/bin/pip" install -r "${BACKEND_DIR}/requirements.txt"

          # --- Create .env file from GitHub Secrets ---
          echo "Creating .env file for the application"
          sudo tee "${BACKEND_DIR}/.env" > /dev/null <<EOF
          # This file is automatically generated during deployment
          SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}
          SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}
          SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}
          SQL_SERVER_PASSWORD='${{ secrets.JINHENGTAI_DB_PASSWORD }}'
          SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}
          EOF

          # --- Restart the backend service ---
          # Note: Assumes a systemd service named '${SERVICE_NAME}' is configured.
          echo "Restarting the backend service (${SERVICE_NAME})"
          sudo systemctl daemon-reload
          sudo systemctl restart "${SERVICE_NAME}"
          sudo systemctl status "${SERVICE_NAME}" --no-pager

          echo "--- Backend deployment finished successfully! ---"
