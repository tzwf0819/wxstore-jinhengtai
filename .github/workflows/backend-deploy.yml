name: Backend API Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: pip
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file for testing
      working-directory: backend
      run: |
        echo "SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}" >> .env
        echo "SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}" >> .env
        echo "SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}" >> .env
        echo "SQL_SERVER_PASSWORD='${{ secrets.JINHENGTAI_DB_PASSWORD }}'" >> .env
        echo "SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}" >> .env

    - name: Run tests
      working-directory: backend
      run: pytest

    - name: Create deployment package
      working-directory: backend
      run: tar -czf ../backend-deploy.tar.gz .

    - name: Deploy package to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        source: "backend-deploy.tar.gz"
        target: "/tmp/"

    - name: Setup backend on server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.JINHENGTAI_HOST }}
        username: ${{ secrets.JINHENGTAI_USERNAME }}
        password: ${{ secrets.JINHENGTAI_PASSWORD }}
        port: 22
        timeout: 120s
        script: |
          set -euo pipefail
          
          PROJECT_DIR="/opt/cloudbase"
          BACKEND_DIR="${PROJECT_DIR}/backend"
          VENV_DIR="${PROJECT_DIR}/venv"
          SERVICE_NAME="jinhengtai-backend"
          TIMESTAMP="$(date +%Y%m%d_%H%M%S)"

          echo "--- Starting backend deployment at ${TIMESTAMP} ---"

          sudo mkdir -p "${PROJECT_DIR}" "${PROJECT_DIR}/backup"

          if [ -d "${BACKEND_DIR}" ]; then
              echo "Backing up existing backend..."
              sudo mv "${BACKEND_DIR}" "/opt/cloudbase/backup/backend_${TIMESTAMP}"
          fi
          
          echo "Extracting new backend code..."
          sudo mkdir -p "${BACKEND_DIR}"
          sudo tar -xzf "/tmp/backend-deploy.tar.gz" -C "${BACKEND_DIR}"
          sudo rm "/tmp/backend-deploy.tar.gz"

          if [ ! -d "${VENV_DIR}" ]; then
              echo "Creating Python virtual environment..."
              sudo python3 -m venv "${VENV_DIR}"
          fi

          echo "Installing Python dependencies..."
          sudo "${VENV_DIR}/bin/pip" install --upgrade pip
          sudo "${VENV_DIR}/bin/pip" install -r "${BACKEND_DIR}/requirements.txt"

          echo "Creating .env file..."
          sudo tee "${BACKEND_DIR}/.env" > /dev/null <<EOF
          SQL_SERVER_HOST=${{ secrets.JINHENGTAI_DB_HOST }}
          SQL_SERVER_PORT=${{ secrets.JINHENGTAI_DB_PORT }}
          SQL_SERVER_USER=${{ secrets.JINHENGTAI_DB_USER }}
          SQL_SERVER_PASSWORD='${{ secrets.JINHENGTAI_DB_PASSWORD }}'
          SQL_SERVER_DATABASE=${{ secrets.JINHENGTAI_DB_NAME }}
          EOF

          echo "Restarting the backend service..."
          sudo systemctl daemon-reload
          sudo systemctl restart "${SERVICE_NAME}"
          sudo systemctl status "${SERVICE_NAME}" --no-pager

          echo "--- Backend deployment finished successfully! ---"
