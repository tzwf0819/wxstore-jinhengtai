name: Health Check

on:
  schedule:
    # 每5分钟检查一次服务状态
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check API Health
      run: |
        echo "Checking API health status..."
        
        # 检查API健康状态
        API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.JINHENGTAI_HOST }}:3000/health || echo "000")
        
        if [ "$API_STATUS" = "200" ]; then
          echo "✅ API Service: Healthy (HTTP $API_STATUS)"
        else
          echo "❌ API Service: Unhealthy (HTTP $API_STATUS)"
          echo "Attempting to restart service..."
          
          # 尝试重启服务
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"restart_service"}'
        fi
        
        # 检查数据库连接
        echo "Checking database connection..."
        DB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.JINHENGTAI_HOST }}:3000/api/health/db || echo "000")
        
        if [ "$DB_STATUS" = "200" ]; then
          echo "✅ Database: Connected"
        else
          echo "❌ Database: Connection failed (HTTP $DB_STATUS)"
        fi
        
        # 显示服务统计信息
        echo "Fetching service statistics..."
        curl -s http://${{ secrets.JINHENGTAI_HOST }}:3000/api/health/stats || echo "Stats endpoint unavailable"